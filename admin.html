<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Scammer Reports</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 980px; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
    input { width: 100%; padding: 10px; margin: 6px 0 12px; }
    button { padding: 8px 10px; cursor: pointer; margin-right: 8px; }
    img { max-width: 200px; border-radius: 8px; border: 1px solid #eee; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Admin Approval</h1>

<div id="authBox">
  <h3>Sign in</h3>
  <input id="email" placeholder="Email" />
  <input id="password" placeholder="Password" type="password" />
  <button id="loginBtn">Login</button>
  <div id="authStatus"></div>
</div>

<div id="adminBox" style="display:none;">
  <button id="logoutBtn">Logout</button>
  <h2>Pending reports</h2>
  <div id="pending"></div>
</div>

<script>
  const SUPABASE_URL = "https://efrijmrcuvtwjwgcttou.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_BH_9cL6k97CQ4h1MkVXJjg_edZ2K4iW";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const authStatus = document.getElementById("authStatus");
  const authBox = document.getElementById("authBox");
  const adminBox = document.getElementById("adminBox");
  const pendingEl = document.getElementById("pending");

  async function refreshUI() {
    const { data: { user } } = await sb.auth.getUser();
    if (!user) {
      authBox.style.display = "block";
      adminBox.style.display = "none";
      return;
    }
    authBox.style.display = "none";
    adminBox.style.display = "block";
    loadPending();
  }

  document.getElementById("loginBtn").addEventListener("click", async () => {
    authStatus.textContent = "Signing in...";
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    const { error } = await sb.auth.signInWithPassword({ email, password });
    authStatus.textContent = error ? (error.message || "Login failed") : "Logged in";
    refreshUI();
  });

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await sb.auth.signOut();
    refreshUI();
  });

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadPending() {
    pendingEl.innerHTML = "Loading...";
    const { data, error } = await sb
      .from("scammer_reports")
      .select("id, created_at, name, telegram, info, screenshot_url, status")
      .eq("status", "pending")
      .order("created_at", { ascending: false })
      .limit(200);

    if (error) {
      pendingEl.innerHTML = "You may not be an admin (or RLS blocked).";
      return;
    }

    if (!data || !data.length) {
      pendingEl.innerHTML = "No pending reports.";
      return;
    }

    pendingEl.innerHTML = data.map(x => `
      <div class="card">
        <div><b>${escapeHtml(x.name)}</b></div>
        <div>Telegram: ${escapeHtml(x.telegram)}</div>
        ${x.info ? `<div style="margin-top:6px">${escapeHtml(x.info)}</div>` : ""}
        ${x.screenshot_url ? `<div style="margin-top:10px">
          <a href="${escapeHtml(x.screenshot_url)}" target="_blank" rel="noopener">
            <img src="${escapeHtml(x.screenshot_url)}" />
          </a></div>` : ""}
        <div style="margin-top:10px">
          <button onclick="approve('${x.id}')">Approve</button>
          <button onclick="reject('${x.id}')">Reject</button>
        </div>
      </div>
    `).join("");
  }

  window.approve = async (id) => {
    const { error } = await sb.from("scammer_reports").update({
      status: "approved",
      approved_at: new Date().toISOString()
    }).eq("id", id);

    if (error) alert(error.message || "Approve failed");
    loadPending();
  };

  window.reject = async (id) => {
    const { error } = await sb.from("scammer_reports").update({
      status: "rejected",
      approved_at: new Date().toISOString()
    }).eq("id", id);

    if (error) alert(error.message || "Reject failed");
    loadPending();
  };

  refreshUI();
</script>
</body>
</html>
